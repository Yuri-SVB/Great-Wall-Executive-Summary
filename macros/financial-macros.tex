% Financial Macros
% Soft-coded financial calculation and display commands
% Enables parameterized quantification following clean room principles

% =============================================================================
% FINANCIAL DISPLAY FORMATTING
% =============================================================================

% Currency formatting with automatic scaling
\NewDocumentCommand{\currency}{O{} m}{%
  \IfStrEq{#1}{M}{%
    % Millions
    \num[group-separator={,}]{\fpeval{#2/1000}}\,\text{M}%
  }{%
    \IfStrEq{#1}{K}{%
      % Thousands  
      \num[group-separator={,}]{\fpeval{#2}}\,\text{K}%
    }{%
      % Standard formatting
      \CurrencySymbol\num[group-separator={,}]{\fpeval{#2}}%
    }%
  }%
}

% Percentage formatting
\NewDocumentCommand{\percent}{m}{%
  \num{\fpeval{#1*100}}\%%
}

% Growth rate display
\NewDocumentCommand{\growthrate}{m}{%
  \IfBooleanTF{#1 > 0}{%
    +\percent{#1}%
  }{%
    \percent{#1}%
  }%
}

% =============================================================================
% FINANCIAL CALCULATIONS
% =============================================================================

% Revenue calculation for any year
\NewDocumentCommand{\revenueyear}{m}{%
  \fpeval{%
    \IfStrEq{#1}{1}{\RevenueYearOne}{%
      \IfStrEq{#1}{2}{\RevenueYearTwo}{%
        \IfStrEq{#1}{3}{\RevenueYearThree}{%
          \IfStrEq{#1}{4}{\RevenueYearFour}{%
            \IfStrEq{#1}{5}{\RevenueYearFive}{0}%
          }%
        }%
      }%
    }%
  }%
}

% Gross profit calculation
\NewDocumentCommand{\grossprofityear}{m}{%
  \fpeval{%
    \revenueyear{#1} * %
    \IfStrEq{#1}{1}{\GrossMarginYearOne}{%
      \IfStrEq{#1}{2}{\GrossMarginYearTwo}{%
        \IfStrEq{#1}{3}{\GrossMarginYearThree}{%
          \IfStrEq{#1}{4}{\GrossMarginYearFour}{%
            \IfStrEq{#1}{5}{\GrossMarginYearFive}{0}%
          }%
        }%
      }%
    }%
  }%
}

% Market size with growth
\NewDocumentCommand{\marketsize}{m}{%
  \fpeval{%
    \TotalAddressableMarket * %
    (1 + \IfStrEq{#1}{1}{\MarketGrowthRateYearOne}{%
      \IfStrEq{#1}{2}{\MarketGrowthRateYearTwo}{%
        \IfStrEq{#1}{3}{\MarketGrowthRateYearThree}{%
          \IfStrEq{#1}{4}{\MarketGrowthRateYearFour}{%
            \IfStrEq{#1}{5}{\MarketGrowthRateYearFive}{0}%
          }%
        }%
      }%
    })^(#1-1)%
  }%
}

% =============================================================================
% VALUATION CALCULATIONS
% =============================================================================

% Revenue multiple valuation
\NewDocumentCommand{\valuationrevmultiple}{O{base} m}{%
  \fpeval{%
    \revenueyear{#2} * %
    \IfStrEq{#1}{low}{\RevenueMultipleLow}{%
      \IfStrEq{#1}{high}{\RevenueMultipleHigh}{%
        \RevenueMultipleBase%
      }%
    }%
  }%
}

% DCF present value calculation (simplified)
\NewDocumentCommand{\presentvalue}{m m}{%
  \fpeval{#1 / (1 + \DiscountRate)^(#2)}%
}

% Terminal value calculation
\NewDocumentCommand{\terminalvalue}{m}{%
  \fpeval{#1 * (1 + \TerminalGrowthRate) / (\DiscountRate - \TerminalGrowthRate)}%
}

% =============================================================================
% FINANCIAL RATIOS AND METRICS
% =============================================================================

% Return on investment
\NewDocumentCommand{\roi}{m m}{%
  \percent{\fpeval{(#1 - #2) / #2}}%
}

% Compound annual growth rate
\NewDocumentCommand{\cagr}{m m m}{%
  \percent{\fpeval{((#2/#1)^(1/#3)) - 1}}%
}

% Customer metrics
\NewDocumentCommand{\ltvcac}{}{%
  \fpeval{\LifetimeValue / \CustomerAcquisitionCost}%
}

% Payback period in months
\NewDocumentCommand{\paybackperiod}{}{%
  \fpeval{\CustomerAcquisitionCost / (\LifetimeValue / 12 * (1 - \MonthlyChurnRate))}%
}

% =============================================================================
% SCENARIO ANALYSIS MACROS
% =============================================================================

% Scenario comparison table row
\NewDocumentCommand{\scenariorow}{m m m m}{%
  #1 & \currency[M]{#2} & \currency[M]{#3} & \currency[M]{#4} \\
}

% Risk-adjusted valuation
\NewDocumentCommand{\riskadjustedvalue}{m}{%
  \fpeval{#1 * (1 - \RiskAdjustmentFactor)}%
}

% Sensitivity analysis
\NewDocumentCommand{\sensitivity}{m m}{%
  \fpeval{#1 * (1 + #2)}%
}