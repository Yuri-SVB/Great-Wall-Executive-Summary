% Financial Macros
% Soft-coded financial calculation and display commands
% Enables parameterized quantification following clean room principles

% =============================================================================
% FINANCIAL DISPLAY FORMATTING
% =============================================================================

% Currency formatting with automatic scaling
\newcommand{\currency}[2][]{%
  \ifthenelse{\equal{#1}{M}}{%
    % Millions
    \CurrencySymbol\pgfmathparse{#2/1000}\pgfmathprintnumber{\pgfmathresult}M%
  }{%
    \ifthenelse{\equal{#1}{K}}{%
      % Thousands  
      \CurrencySymbol\pgfmathparse{#2}\pgfmathprintnumber{\pgfmathresult}K%
    }{%
      % Standard formatting
      \CurrencySymbol\pgfmathparse{#2}\pgfmathprintnumber[fixed, precision=0]{\pgfmathresult}%
    }%
  }%
}

% Percentage formatting
\newcommand{\percent}[1]{%
  \pgfmathparse{#1*100}\pgfmathprintnumber[fixed, precision=1]{\pgfmathresult}\%%
}

% Growth rate display
\newcommand{\growthrate}[1]{%
  \pgfmathparse{#1}%
  \ifdim\pgfmathresult pt>0pt%
    +\percent{#1}%
  \else%
    \percent{#1}%
  \fi%
}

% =============================================================================
% SIMPLIFIED FINANCIAL CALCULATIONS
% =============================================================================

% Revenue calculation for any year (hardcoded for reliability)
\newcommand{\revenueyear}[1]{%
  \ifthenelse{\equal{#1}{1}}{\RevenueYearOne}{%
    \ifthenelse{\equal{#1}{2}}{\RevenueYearTwo}{%
      \ifthenelse{\equal{#1}{3}}{\RevenueYearThree}{%
        \ifthenelse{\equal{#1}{4}}{\RevenueYearFour}{%
          \ifthenelse{\equal{#1}{5}}{\RevenueYearFive}{0}%
        }%
      }%
    }%
  }%
}

% Gross profit calculation (simplified)
\newcommand{\grossprofityear}[1]{%
  \ifthenelse{\equal{#1}{1}}{\pgfmathparse{\RevenueYearOne*\GrossMarginYearOne}\pgfmathprintnumber[fixed, precision=0]{\pgfmathresult}}{%
    \ifthenelse{\equal{#1}{2}}{\pgfmathparse{\RevenueYearTwo*\GrossMarginYearTwo}\pgfmathprintnumber[fixed, precision=0]{\pgfmathresult}}{%
      \ifthenelse{\equal{#1}{3}}{\pgfmathparse{\RevenueYearThree*\GrossMarginYearThree}\pgfmathprintnumber[fixed, precision=0]{\pgfmathresult}}{%
        \ifthenelse{\equal{#1}{4}}{\pgfmathparse{\RevenueYearFour*\GrossMarginYearFour}\pgfmathprintnumber[fixed, precision=0]{\pgfmathresult}}{%
          \ifthenelse{\equal{#1}{5}}{\pgfmathparse{\RevenueYearFive*\GrossMarginYearFive}\pgfmathprintnumber[fixed, precision=0]{\pgfmathresult}}{0}%
        }%
      }%
    }%
  }%
}

% =============================================================================
% VALUATION CALCULATIONS
% =============================================================================

% Revenue multiple valuation
\newcommand{\valuationrevmultiple}[2][base]{%
  \ifthenelse{\equal{#1}{low}}{%
    \pgfmathparse{\revenueyear{#2}*\RevenueMultipleLow}\pgfmathprintnumber[fixed, precision=0]{\pgfmathresult}%
  }{%
    \ifthenelse{\equal{#1}{high}}{%
      \pgfmathparse{\revenueyear{#2}*\RevenueMultipleHigh}\pgfmathprintnumber[fixed, precision=0]{\pgfmathresult}%
    }{%
      \pgfmathparse{\revenueyear{#2}*\RevenueMultipleBase}\pgfmathprintnumber[fixed, precision=0]{\pgfmathresult}%
    }%
  }%
}

% =============================================================================
% FINANCIAL RATIOS AND METRICS
% =============================================================================

% Return on investment
\newcommand{\roi}[2]{%
  \pgfmathparse{(#1 - #2) / #2 * 100}\pgfmathprintnumber[fixed, precision=1]{\pgfmathresult}\%%
}

% Compound annual growth rate
\newcommand{\cagr}[3]{%
  \pgfmathparse{(pow(#2/#1, 1/#3) - 1) * 100}\pgfmathprintnumber[fixed, precision=1]{\pgfmathresult}\%%
}

% Customer metrics
\newcommand{\ltvcac}{%
  \pgfmathparse{\LifetimeValue / \CustomerAcquisitionCost}\pgfmathprintnumber[fixed, precision=1]{\pgfmathresult}%
}

% Risk-adjusted valuation
\newcommand{\riskadjustedvalue}[1]{%
  \pgfmathparse{#1 * (1 - \RiskAdjustmentFactor)}\pgfmathprintnumber[fixed, precision=0]{\pgfmathresult}%
}